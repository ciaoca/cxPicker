/*!
 * cxPicker
 * 
 * @version 1.0.0
 * @author ciaoca
 * @email ciaoca@gmail.com
 * @site https://github.com/ciaoca/cxPicker
 * @license Released under the MIT license
 */
!function(){var b,a={dom:{}};a.init=function(){var a=this;a.loopTime=200,a.dom.wrap=document.createElement("div"),a.dom.wrap.classList.add("cxpicker"),a.dom.wrap.innerHTML='<div class="mask"></div><div class="box"><div class="acts"><a class="cancel" href="javascript://" rel="cxpicker_hide"></a><a class="set" href="javascript://" rel="cxpicker_set"></a></div><div class="list"></div></div></div>',a.dom.list=a.dom.wrap.querySelector(".list"),"ontouchend"in document.documentElement?a.dom.list.addEventListener("touchend",function(){a.checkStable()}):a.dom.list.addEventListener("mousewheel",function(){clearTimeout(a.scrollThrottle),a.scrollThrottle=setTimeout(function(){a.checkStable()},a.loopTime)}),a.dom.wrap.addEventListener("click",function(){var d,e,b=event.target,c="";if("string"==typeof b.nodeName&&(c=b.nodeName.toLowerCase()),"a"===c)switch(b.rel){case"cxpicker_hide":a.hide();break;case"cxpicker_set":a.confirm()}else if("div"===c)for(d=0,e=b.classList.length;e>d;d++)if("mask"===b.classList[d]){a.hide();break}}),document.body.insertAdjacentElement("beforeend",a.dom.wrap)},a.setOptions=function(a){var c=this;c.options=Object.assign({},b.defaults,a),"string"==typeof c.options.jsonValue&&c.options.jsonValue.length||(c.options.jsonValue=c.options.jsonName)},a.attach=function(a){var b=this;return b.setOptions(a),Array.isArray(b.options.data)?(0===b.options.selectLength&&(b.options.selectLength=b.options.data.length),b.cacheData=b.options.data,b.cacheSelect=[],b.cacheResult=[],b.buildSelect(),b.show(),void 0):(console.warn("cxPicker: data is not array."),void 0)},a.buildSelect=function(){var b,c,d,f,g,h,i,j,a=this,e="";for(f=0;f<a.options.selectLength;f++){if(b=Array.isArray(d)?d:a.cacheData.length-f>0?a.cacheData[f]:[],c={index:0},b.length&&a.options.value.length-f>0)for(g=0,h=b.length;h>g;g++)if(b[g]===a.options.value[f]||"object"==typeof b[g]&&b[g][a.options.jsonValue]===a.options.value[f]){c.index=g,"object"==typeof b[g]?(c.label=b[g][a.options.jsonName],c.value=b[g][a.options.jsonValue]):(c.label=b[g],c.value=b[g]);break}"undefined"==typeof c.value&&("object"==typeof b[0]?(c.label=b[0][a.options.jsonName],c.value=b[0][a.options.jsonValue]):(c.label=b[0],c.value=b[0])),d="object"==typeof b[c.index]&&Array.isArray(b[c.index][a.options.jsonSub])?b[c.index][a.options.jsonSub]:null,Array.isArray(d)&&("number"!=typeof a.subStart||f<a.subStart)&&(a.subStart=f),a.cacheSelect.push(b),a.cacheResult.push(c)}for(f=0,i=a.cacheSelect.length;i>f;f++)e+=a.createList(a.cacheSelect[f]);for(a.dom.list.innerHTML=e,j=a.dom.list.getElementsByTagName("ul"),a.itemHeight=a.dom.list.getElementsByTagName("li")[0].offsetHeight,f=0,i=a.cacheResult.length;i>f;f++)a.cacheResult[f].top=a.itemHeight*a.cacheResult[f].index,j[f].scrollTop=a.cacheResult[f].top},a.createList=function(a){var d,e,b=this,c=[];for(d=0,e=a.length;e>d;d++)c.push(b.createItem(a[d]));return"<section><ul>"+c.join("")+"</ul></section>"},a.createItem=function(a){var b=this,c="";return c="object"==typeof a?'<li data-value="'+a[b.options.jsonValue]+'">'+a[b.options.jsonName]+"</li>":'<li data-value="'+a+'">'+a+"</li>"},a.show=function(){var a=this;a.dom.wrap.classList.remove("out"),a.dom.wrap.classList.add("in")},a.hide=function(){var a=this;a.dom.wrap.classList.remove("in"),a.dom.wrap.classList.add("out")},a.confirm=function(){var a=this;a.checkStable(!0),"function"==typeof a.options.callback&&a.options.callback(a.getResult()),a.hide()},a.checkStable=function(a){var e,f,b=this,c=b.dom.list.getElementsByTagName("ul"),d=!0;if(a&&(b.checkLock=!1),!b.checkLock){for(clearTimeout(b.checkLoop),e=0,f=c.length;f>e;e++)if(b.cacheResult[e].top!==c[e].scrollTop){b.cacheResult[e].index=b.cacheResult[e].top>c[e].scrollTop?Math.ceil(c[e].scrollTop/b.itemHeight):Math.floor(c[e].scrollTop/b.itemHeight),b.cacheResult[e].top=c[e].scrollTop,d=!1;break}return d||a?(b.checkSelect(),void 0):(b.checkLock=!0,b.checkLoop=setTimeout(function(){b.checkLock=!1,b.checkStable()},b.loopTime),void 0)}},a.checkSelect=function(){var b,c,d,e,f,g,h,a=this;for(h=0;h<a.options.selectLength;h++)b=a.cacheResult[h].index,c=a.cacheResult[h].value,d=a.cacheSelect[h][b],"object"==typeof d?(f=d[a.options.jsonName],g=d[a.options.jsonValue],e=Array.isArray(d[a.options.jsonSub])?d[a.options.jsonSub]:null):(f=d,g=d,e=null),Array.isArray(e)&&("number"!=typeof a.subStart||h<a.subStart)&&(a.subStart=h),c===g||(a.cacheResult[h].label=f,a.cacheResult[h].value=g,"number"==typeof a.subStart&&a.subStart<=h&&a.clearSelect(h))},a.clearSelect=function(a){var c,d,g,b=this,e=a+1,f=b.dom.list.getElementsByTagName("section");for(Array.isArray(b.cacheSelect[a][b.cacheResult[a].index][b.options.jsonSub])&&(c=b.cacheSelect[a][b.cacheResult[a].index][b.options.jsonSub]),b.cacheSelect.splice(e,b.options.selectLength-a),b.cacheResult.splice(e,b.options.selectLength-a),g=e;g<b.options.selectLength;g++)Array.isArray(c)||(c=[]),d={index:0},"object"==typeof c[0]?(d.label=c[0][b.options.jsonName],d.value=c[0][b.options.jsonValue]):(d.label=c[0],d.value=c[0]),b.cacheSelect.push(c),b.cacheResult.push(d),f[g].insertAdjacentHTML("afterend",b.createList(c)),b.dom.list.removeChild(f[g]),c="object"==typeof c[d.index]&&Array.isArray(c[d.index][b.options.jsonSub])?c[d.index][b.options.jsonSub]:null},a.getResult=function(){var c,a=this,b={label:[],value:[]};for(c=0;c<a.cacheResult.length&&("object"!=typeof a.cacheResult[c]||"undefined"!=typeof a.cacheResult[c].value);c++)b.label.push(a.cacheResult[c].label),b.value.push(a.cacheResult[c].value);return b},b=function(){return b.attach.apply(b,arguments)},b.attach=function(){a.attach.apply(a,arguments)},b.defaults={value:[],selectLength:0,jsonName:"n",jsonValue:"v",jsonSub:"s"},document.addEventListener("DOMContentLoaded",function(){a.init()}),window.cxPicker=b}();